<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Inequality Simulator - Logic Visualization</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>
  <style>
    body { background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    h1 { padding: 10px 20px; margin: 0; background-color: #2c3e50; font-size: 1.2rem; }
    #blocklyDiv { flex-grow: 1; width: 100%; }
    .header { background: #34495e; padding: 10px; display: flex; align-items: center; gap: 10px; }
    button { padding: 10px 20px; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }
    #saveBtn { background: #27ae60; }
    #resetBtn { background: #e67e22; }
    
    /* Chat UI */
    #chat-container {
        position: fixed; bottom: 20px; right: 20px; width: 350px;
        background: #2d2d2d; border: 1px solid #404040; border-radius: 8px;
        display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        z-index: 1000;
    }
    #chat-header { padding: 10px; background: #2196f3; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer; }
    #chat-body { height: 300px; overflow-y: auto; padding: 10px; display: none; }
    #chat-input-area { padding: 10px; border-top: 1px solid #404040; display: none; }
    #chat-input { width: 70%; padding: 5px; background: #404040; color: white; border: 1px solid #555; border-radius: 4px; }
    #send-btn { width: 25%; background: #2196f3; padding: 5px; font-size: 12px; }
    .msg { margin-bottom: 8px; padding: 6px; border-radius: 4px; font-size: 0.9em; }
    .msg.user { background: #34495e; text-align: right; }
    .msg.bot { background: #444; }
    .install-btn { background: #e67e22; font-size: 0.8em; padding: 4px 8px; margin-top: 5px; display: block; width: 100%; }
  </style>
</head>
<body>
  <h1>Policy Editor</h1>
  <div class="header">
    <button id="saveBtn" onclick="generateAndSave()">Update Simulation Logic</button>
    <button id="resetBtn" onclick="resetLogic()">Reset to Default</button>
    <span id="saveStatus" style="color: #bdc3c7; font-size: 0.9em;"></span>
  </div>

  <div id="blocklyDiv"></div>

  <div id="chat-container">
    <div id="chat-header" onclick="toggleChat()">Policy Assistant (Click to Toggle)</div>
    <div id="chat-body"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="E.g., Create a UBI policy...">
        <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Agent Logic" colour="120">
      <block type="agent_step_def"></block>
      <block type="update_history"></block>
      <block type="calc_agent_metrics"></block>
    </category>
    <category name="Policies" colour="0" id="policyCategory">
      <block type="execute_wealth_exchange"></block>
      <block type="execute_fascism"></block>
      <block type="execute_capitalism"></block>
      <block type="execute_communism"></block>
    </category>
    <category name="Control" colour="210">
      <block type="check_policy"></block>
      <block type="check_elite"></block>
    </category>
    <category name="Custom" colour="290" id="customCategory"></category>
  </xml>

  <script>
    // --- 1. BLOCKLY SETUP ---
    Blockly.Python.INDENT = '    ';
    
    // Define base blocks
    Blockly.defineBlocksWithJsonArray([
      { "type": "agent_step_def", "message0": "Agent Action %1 %2", "args0": [ { "type": "input_dummy" }, { "type": "input_statement", "name": "STEPS" } ], "colour": 120 },
      { "type": "update_history", "message0": "Update History", "previousStatement": null, "nextStatement": null, "colour": 120 },
      { "type": "check_policy", "message0": "If Policy is %1", "args0": [ { "type": "field_dropdown", "name": "OPTION", "options": [ ["Fascism", "fascism"], ["Capitalism", "capitalism"], ["Communism", "communism"], ["Econophysics", "econophysics"] ] } ], "message1": "%1", "args1": [{ "type": "input_statement", "name": "DO" }], "previousStatement": null, "nextStatement": null, "colour": 210 },
      { "type": "execute_fascism", "message0": "Execute Fascism", "previousStatement": null, "nextStatement": null, "colour": 0 },
      { "type": "execute_capitalism", "message0": "Execute Capitalism", "previousStatement": null, "nextStatement": null, "colour": 0 },
      { "type": "execute_communism", "message0": "Execute Communism", "previousStatement": null, "nextStatement": null, "colour": 0 },
      { "type": "execute_wealth_exchange", "message0": "Wealth Exchange", "previousStatement": null, "nextStatement": null, "colour": 0 },
      { "type": "check_elite", "message0": "If Not Elite %1", "args0": [{ "type": "input_statement", "name": "DO" }], "previousStatement": null, "nextStatement": null, "colour": 210 },
      { "type": "calc_agent_metrics", "message0": "Calc Metrics", "previousStatement": null, "nextStatement": null, "colour": 120 }
    ]);

    // Generators
    Blockly.Python['agent_step_def'] = function(block) { return 'def step(self):\n    self.previous = self.bracket\n' + Blockly.Python.statementToCode(block, 'STEPS'); };
    Blockly.Python['check_policy'] = function(block) { return 'if self.model.policy == "' + block.getFieldValue('OPTION') + '":\n' + Blockly.Python.statementToCode(block, 'DO'); };
    Blockly.Python['execute_fascism'] = function() { return 'Fascism().execute(self)\n'; };
    Blockly.Python['execute_capitalism'] = function() { return 'Capitalism().execute(self)\n'; };
    Blockly.Python['execute_communism'] = function() { return 'Communism().execute(self.model)\n'; };
    Blockly.Python['execute_wealth_exchange'] = function() { return 'WealthExchange().execute(self)\n'; };
    Blockly.Python['check_elite'] = function(block) { return 'if self.party_elite == False:\n' + Blockly.Python.statementToCode(block, 'DO'); };
    Blockly.Python['update_history'] = function() { return 'self.bracket_history.append(self.bracket)\nif len(self.bracket_history) > 20: self.bracket_history = self.bracket_history[-20:]\n'; };
    Blockly.Python['calc_agent_metrics'] = function() { return 'if self.wealth < self.model.brackets[0]: self.bracket = "Lower"\nelif self.wealth >= self.model.brackets[1]: self.bracket = "Upper"\nelse: self.bracket = "Middle"\nself.mobility = calculate_bartholomew_mobility(self)\n'; };

    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      scrollbars: true,
      zoom: { controls: true, wheel: true, startScale: 0.8 },
      theme: Blockly.Themes.Dark
    });

    // Default Workspace XML
    var startXml = '<xml><block type="agent_step_def" x="20" y="20"><statement name="STEPS"><block type="update_history"><next><block type="check_policy"><field name="OPTION">econophysics</field><statement name="DO"><block type="execute_wealth_exchange"></block></statement><next><block type="calc_agent_metrics"></block></next></block></next></block></statement></block></xml>';
    Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(startXml), workspace);

    // --- 2. CHAT & DYNAMIC BLOCK LOGIC ---
    function toggleChat() {
        var body = document.getElementById('chat-body');
        var input = document.getElementById('chat-input-area');
        var display = body.style.display === 'none' ? 'block' : 'none';
        body.style.display = display;
        input.style.display = display;
    }

    function addMessage(text, sender) {
        var div = document.createElement('div');
        div.className = 'msg ' + sender;
        div.innerText = text;
        document.getElementById('chat-body').appendChild(div);
        document.getElementById('chat-body').scrollTop = document.getElementById('chat-body').scrollHeight;
    }

    function sendMessage() {
        var input = document.getElementById('chat-input');
        var msg = input.value;
        if (!msg) return;
        addMessage(msg, 'user');
        input.value = '';

        fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: msg })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                addMessage("Error: " + data.error, 'bot');
                return;
            }
            
            // Try to parse JSON from the response text
            // The LLM might wrap JSON in ```json ... ``` or just return text
            var text = data.response;
            var jsonMatch = text.match(/\{[\s\S]*\}/);
            
            if (jsonMatch) {
                try {
                    var payload = JSON.parse(jsonMatch[0]);
                    addMessage("I generated a new policy block for you.", 'bot');
                    
                    var btn = document.createElement('button');
                    btn.className = 'install-btn';
                    btn.innerText = "Install Block: " + (payload.block_json.type || "New Policy");
                    btn.onclick = function() { installPolicy(payload); btn.disabled = true; btn.innerText = "Installed"; };
                    document.getElementById('chat-body').appendChild(btn);
                } catch(e) {
                    addMessage(text, 'bot');
                }
            } else {
                addMessage(text, 'bot');
            }
        })
        .catch(e => addMessage("Connection Error", 'bot'));
    }

    function installPolicy(payload) {
        // 1. Define Block
        Blockly.defineBlocksWithJsonArray([payload.block_json]);
        
        // 2. Define Generator
        // Using eval here to register the function provided by SLM string
        // Safety: Ensure SLM prompt forces valid JS assignment to Blockly.Python['type']
        try {
            // We assume payload.block_generator is like: "Blockly.Python['my_block'] = function(block){...}"
            eval(payload.block_generator);
            
            // 3. Send Python Code to Backend
            fetch('/api/add_custom_policy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: payload.python_code })
            }).then(() => {
                // 4. Update Toolbox
                var toolbox = document.getElementById('toolbox');
                var customCat = document.getElementById('customCategory');
                var newBlock = document.createElement('block');
                newBlock.setAttribute('type', payload.block_json.type);
                customCat.appendChild(newBlock);
                workspace.updateToolbox(toolbox);
                alert("Block Installed! Look in the 'Custom' category.");
            });
            
        } catch(e) {
            console.error(e);
            alert("Failed to install block definition.");
        }
    }

    // --- 3. SAVE/RESET LOGIC ---
    function generateAndSave() {
        var code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById('saveStatus').innerText = "Sending...";
        fetch('/api/update_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code: code })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('saveStatus').innerText = "Saved!";
            setTimeout(() => document.getElementById('saveStatus').innerText = "", 2000);
        });
    }

    function resetLogic() {
        if(!confirm("Reset logic?")) return;
        fetch('/api/reset_code', { method: 'POST' })
        .then(res => res.json())
        .then(data => alert("Reset Complete"));
    }
  </script>
</body>
</html>