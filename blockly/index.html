<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Inequality Simulator - Policy Editor</title>
  
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/python_compressed.js"></script>
  <script>
    if (Blockly.Python) {
        Blockly.Python.INDENT = '    ';
    }
  </script>

  <script src="custom_blocks.js"></script>
  <script src="user_blocks.js"></script> 
  
  <style>
    body { background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    h1 { padding: 10px 20px; margin: 0; background-color: #2c3e50; font-size: 1.2rem; }
    #blocklyDiv { flex-grow: 1; width: 100%; }
    .header { background: #34495e; padding: 10px; display: flex; align-items: center; gap: 10px; }
    button { padding: 10px 20px; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }
    #saveBtn { background: #27ae60; }
    #resetBtn { background: #e67e22; }
    
    /* Chat UI Styles */
    #chat-container {
        position: fixed; top: 100px; right: 20px; width: 350px;
        background: white; color: #333; border: 1px solid #404040; 
        border-radius: 8px; display: flex; flex-direction: column; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 1000;
    }
    #chat-header { padding: 10px; background: #2196f3; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer; color: white; }
    #chat-body { height: 350px; overflow-y: auto; padding: 10px; display: none; background: #f9f9f9; }
    #chat-input-area { padding: 10px; border-top: 1px solid #ddd; display: none; background: #fff; }
    #chat-input { width: 70%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    #send-btn { width: 25%; background: #2196f3; padding: 8px; font-size: 12px; }
    .msg { margin-bottom: 8px; padding: 8px; border-radius: 6px; font-size: 0.9em; word-wrap: break-word; }
    .msg.user { background: #e3f2fd; text-align: right; border: 1px solid #bbdefb; }
    .msg.bot { background: #ffffff; border: 1px solid #e0e0e0; }
    .status-log { font-size: 0.8em; color: #666; font-family: monospace; white-space: pre-wrap; margin-top: 5px; background: #f0f0f0; padding: 5px; border-radius: 4px; }
    .install-btn { background: #e67e22; font-size: 0.9em; padding: 8px 12px; margin-top: 10px; display: block; width: 100%; }
    .loading { font-style: italic; color: #888; }
  </style>
</head>
<body>
  <h1>Policy Editor (Update Policies Agents Follow)</h1>
  <div class="header">
    <button id="saveBtn" onclick="generateAndSave()">Update Agent Logic</button>
    <button id="resetBtn" onclick="resetLogic()">Reset to Default</button>
    <span id="saveStatus" style="color: #bdc3c7; font-size: 0.9em;"></span>
  </div>

  <div id="blocklyDiv"></div>

  <div id="chat-container">
    <div id="chat-header" onclick="toggleChat()">ü§ñ Policy Assistant</div>
    <div id="chat-body"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="E.g., Create a policy that...">
        <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Agent Logic" colour="120">
      <block type="agent_step_def"></block>
      <block type="update_history"></block>
      <block type="calc_agent_metrics"></block>
    </category>
    <category name="Policies" colour="0" id="policyCategory">
      <block type="execute_wealth_exchange"></block>
      <block type="execute_fascism"></block>
      <block type="execute_capitalism"></block>
      <block type="execute_communism"></block>
    </category>
    <category name="Control" colour="210">
      <block type="check_policy"></block>
      <block type="check_elite"></block>
    </category>
    <category name="Custom" colour="290" id="customCategory"></category>
  </xml>

  <script>
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      scrollbars: true,
      zoom: { controls: true, wheel: true, startScale: 0.8 },
      theme: Blockly.Themes.Dark
    });

    var startXml = `
    <xml>
        <block type="agent_step_def" x="20" y="20">
            <statement name="STEPS">
                <block type="update_history">
                    <next>
                        <block type="check_policy">
                            <field name="OPTION">fascism</field>
                            <statement name="DO">
                                <block type="execute_fascism">
                                    <next>
                                        <block type="check_elite">
                                            <statement name="DO">
                                                <block type="execute_wealth_exchange"></block>
                                            </statement>
                                        </block>
                                    </next>
                                </block>
                            </statement>
                            <next>
                                <block type="check_policy">
                                    <field name="OPTION">capitalism</field>
                                    <statement name="DO">
                                        <block type="execute_capitalism">
                                            <next>
                                                <block type="execute_wealth_exchange"></block>
                                            </next>
                                        </block>
                                    </statement>
                                    <next>
                                        <block type="check_policy">
                                            <field name="OPTION">communism</field>
                                            <statement name="DO">
                                                <block type="execute_communism">
                                                    <next>
                                                        <block type="execute_wealth_exchange"></block>
                                                    </next>
                                                </block>
                                            </statement>
                                            <next>
                                                <block type="check_policy">
                                                    <field name="OPTION">econophysics</field>
                                                    <statement name="DO">
                                                        <block type="execute_wealth_exchange"></block>
                                                    </statement>
                                                    <next>
                                                        <block type="calc_agent_metrics"></block>
                                                    </next>
                                                </block>
                                            </next>
                                        </block>
                                    </next>
                                </block>
                            </next>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
    </xml>`;
    
    Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(startXml), workspace);

    function toggleChat() {
        var body = document.getElementById('chat-body');
        var input = document.getElementById('chat-input-area');
        var display = body.style.display === 'none' ? 'block' : 'none';
        body.style.display = display;
        input.style.display = display;
    }

    function addMessage(text, sender, isHtml = false) {
        var div = document.createElement('div');
        div.className = 'msg ' + sender;
        if (isHtml) div.innerHTML = text;
        else div.innerText = text;
        
        document.getElementById('chat-body').appendChild(div);
        var chatBody = document.getElementById('chat-body');
        chatBody.scrollTop = chatBody.scrollHeight;
        return div;
    }

    function sendMessage() {
        var input = document.getElementById('chat-input');
        var msg = input.value;
        if (!msg) return;
        addMessage(msg, 'user');
        input.value = '';

        // Add loading message
        var loadingMsg = addMessage("Generating and testing code... please wait...", 'bot loading');

        fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: msg })
        })
        .then(res => res.json())
        .then(data => {
            // Remove loading message
            loadingMsg.remove();

            if (data.error) {
                addMessage("‚ùå Error: " + data.error, 'bot');
                return;
            }
            
            var text = data.response;
            var cleanText = text.replace(/```json\n?|```/g, "").trim();

            try {
                var payload = JSON.parse(cleanText);
                if (Array.isArray(payload)) payload = payload[0];
                if (typeof payload.block_json === 'string') payload.block_json = JSON.parse(payload.block_json);
                
                // Fix Statement
                if (payload.block_json.output !== undefined) {
                    delete payload.block_json.output;
                    payload.block_json.previousStatement = null;
                    payload.block_json.nextStatement = null;
                }

                if (payload.block_json && payload.python_code) {
                    // DISPLAY STATUS MESSAGE from backend
                    var status = payload.status_message || "Code Generated Successfully.";
                    var statusDiv = "<div class='status-log'>" + status + "</div>";
                    
                    addMessage(statusDiv + "<br><b>Ready to Install?</b>", 'bot', true);
                    
                    var btn = document.createElement('button');
                    btn.className = 'install-btn';
                    var blockType = payload.block_json.type || "custom_policy";
                    btn.innerText = "Install Block: " + blockType;
                    
                    btn.onclick = function() { 
                        installPolicy(payload); 
                        btn.disabled = true; 
                        btn.innerText = "Installed (Look in Custom)"; 
                    };
                    document.getElementById('chat-body').appendChild(btn);
                    
                    // Scroll to bottom
                    var chatBody = document.getElementById('chat-body');
                    chatBody.scrollTop = chatBody.scrollHeight;
                } else {
                    addMessage("I could not generate a valid block configuration.", 'bot');
                }
            } catch(e) {
                console.error("Parsing Error:", e);
                addMessage("Error parsing AI response.", 'bot');
            }
        })
        .catch(e => {
            if(loadingMsg) loadingMsg.remove();
            console.error(e);
            addMessage("Connection Error", 'bot');
        });
    }

    function installPolicy(payload) {
        if (payload.block_json.output !== undefined) {
             delete payload.block_json.output;
             payload.block_json.previousStatement = null;
             payload.block_json.nextStatement = null;
        }

        if (payload.block_json.previousStatement === null) {
            payload.block_generator = payload.block_generator.replace(
                /return\s*\[\s*([\s\S]*?)\s*,[\s\S]*?\];?/g, 
                "return $1 + '\\n';"
            );
        }

        if (payload.block_generator.includes("Blockly.Python['")) {
            payload.block_generator = payload.block_generator.replace(
                /Blockly\.Python\['/g, 
                "Blockly.Python.forBlock['"
            );
        }

        Blockly.defineBlocksWithJsonArray([payload.block_json]);
        try {
            eval(payload.block_generator);
            
            var p1 = fetch('/api/add_custom_policy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: payload.python_code })
            });

            var p2 = fetch('/api/save_block_definition', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    block_json: payload.block_json,
                    block_generator: payload.block_generator 
                })
            });

            Promise.all([p1, p2]).then(() => {
                var toolbox = document.getElementById('toolbox');
                var customCat = document.getElementById('customCategory');
                
                if (!document.querySelector(`block[type="${payload.block_json.type}"]`)) {
                    var newBlock = document.createElement('block');
                    newBlock.setAttribute('type', payload.block_json.type);
                    customCat.appendChild(newBlock);
                    workspace.updateToolbox(toolbox);
                }
                alert("Block Installed Successfully!\n\nCheck the 'Custom' category.");
            }).catch(e => alert("Error saving block to server: " + e));

        } catch(e) {
            console.error(e);
            alert("Failed to install block definition: " + e);
        }
    }

    function generateAndSave() {
        try {
            var code = Blockly.Python.workspaceToCode(workspace);
            document.getElementById('saveStatus').innerText = "Sending...";
            fetch('/api/update_code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: code })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('saveStatus').innerText = "Saved!";
                setTimeout(() => document.getElementById('saveStatus').innerText = "", 2000);
            });
        } catch (e) {
            console.error("Generator Error:", e);
            alert("Error generating code. Check console for details.\n" + e.message);
        }
    }

    function resetLogic() {
        if(!confirm("Reset logic?")) return;
        fetch('/api/reset_code', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            alert("Reset Complete");
            location.reload(); 
        });
    }
  </script>
</body>
</html>